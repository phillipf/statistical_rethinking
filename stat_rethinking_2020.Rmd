---
title: "Rethinking Stats"
output: html_document
---
```{r}

# devtools::install_github("stan-dev/cmdstanr")

# cmdstanr::check_cmdstan_toolchain(fix = TRUE)
# cmdstanr::install_cmdstan()

# install.packages(c("coda","mvtnorm","devtools","loo","dagitty"))
# devtools::install_github("rmcelreath/rethinking")
```

##Chapter one

```{r setup, include=FALSE}

grid_size <- 100

source(here::here('R', 'utils.R'))
```

```{r}

calc_posterior( 6 , 9 , grid.size = grid.size )

```

```{r}
prior <- ifelse(p_grid < 0.5, 0, 1)

calc_posterior( 6 , 9 , prior, grid.size=grid.size )

prior <- exp( -5*abs( p_grid - 0.5 ) )

calc_posterior( 6 , 9 , prior, grid.size=grid.size )

calc_posterior(6, 9, prior, grid.size=grid.size)
```

```{r}
#Q 2M1
#(1) W, W, W
calc_posterior( 3 , 3 , prior, grid.size=grid.size )
#(2) W, W, W, L
calc_posterior( 3 , 4 , prior, grid.size=grid.size )
#(3) L, W, W, L, W, W, W
calc_posterior( 5 , 7 , prior, grid.size=grid.size )

```

```{r}
# Q 2M2

prior <- ifelse( p_grid < 0.5 , 0 , 1 )

#(1) W, W, W
calc_posterior( 3 , 3 , prior, grid.size=grid.size )
#(2) W, W, W, L
calc_posterior( 3 , 4 , prior, grid.size=grid.size )
#(3) L, W, W, L, W, W, W
calc_posterior( 5 , 7 , prior, grid.size=grid.size )

# (1) W, W, W
calc_posterior(3, 3, prior, grid.size=grid.size )
# (2) W, W, W, L
calc_posterior(3, 4, prior, grid.size=grid.size )
# (3) L, W, W, L, W, W, W
calc_posterior(5, 7, prior, grid.size=grid.size )
```

```{r}

# define prior
prior <- prior
# compute likelihood at each value in grid
likelihood <- dbinom(1, size = 1, prob = 0.3)
# compute product of likelihood and prior
unstd.posterior <- likelihood * prior
# standardize the posterior, so it sums to 1
posterior <- unstd.posterior / sum(unstd.posterior)
```

##Chapter two

##Chapter three

```{r}
p_grid <- seq(from = 0, to = 1, length.out = 1000)
prior <- rep(1, 1000)
likelihood <- dbinom(6, size = 9, prob = p_grid)
unstd.posterior <- likelihood * prior
posterior <- unstd.posterior / sum(posterior)

sample.size <- 1e4

set.seed(100)
samples <- sample(p_grid, prob = posterior, size = sample.size, replace = TRUE)
```


```{r}
plot(p_grid, posterior)

plot(samples)
```

```{r}
library(rethinking)

dens(samples)
```

## Intervals of defined boundaries

### How much posterior probability lies below some parameter value?

```{r}
# add up posterior probability where p < 0.5
sum(posterior[p_grid < 0.5])

# the same calculation, using samples from the posterior
sum(samples < 0.5) / sample.size
```

### How much posterior probability lies between two parameter values?

```{r}
# how much posterior probability lies between 0.5 and 0.75:

sum(samples > 0.5 & samples < 0.75) / sample.size
```

## Intervals of defined mass

```{r}
# you want to know the boundaries of the lower 80% posterior probability. You know this interval starts at p = 0. To find out where it stops, think of the samples as data and ask where the 80th percentile lies.

quantile(samples, 0.8)

# Similarly, the middle 80% interval lies between the 10th percentile and the 90th percentile. These boundaries are found using the same approach

quantile(samples, c(0.1, 0.9))
```


### 3E1. How much posterior probability lies below p = 0.2?
### 3E2. How much posterior probability lies above p = 0.8?
### 3E3. How much posterior probability lies between p = 0.2 and p = 0.8?

```{r}
`3E1` <- sum(posterior[p_grid < 0.2])
`3E2` <- sum(posterior[p_grid > 0.8])
`3E3` <- sum(posterior[p_grid > 0.2 & p_grid < 0.8])

`3E1` + `3E2` + `3E3`
```

### 3E4. 20% of the posterior probability lies below which value of p?
### 3E5. 20% of the posterior probability lies above which value of p?

```{r}
quantile(samples, 0.2)
quantile(samples, 0.8)
```

### 3E6. Which values of p contain the narrowest interval equal to 66% of the posterior probability?
### 3E7. Which values of p contain 66% of the posterior probability, assuming equal posterior probability both below and above the interval?

```{r}

HPDI(samples, prob = 0.66)

PI(samples, prob = 0.66)
```

### 3M1. Suppose the globe tossing data had turned out to be 8 water in 15 tosses. Construct the posterior distribution, using grid approximation. Use the same flat prior as before.

```{r}
n_water <- 8
n <- 15
grid.size <- 1e4

calc_posterior(n_water, n, rep(1, grid.size), grid.size)
```

### 3M2. Draw 10,000 samples from the grid approximation from above. Then use the samples to calculate the 90% HPDI for p.

```{r}

sample.size <- 1e4

set.seed(100)
samples <- sample(p_grid, prob = posterior, size = sample.size, replace = TRUE)

HPDI(samples, 0.9)
```

### 3M3. Construct a posterior predictive check for this model and data. This means simulate the distribution of samples, averaging over the posterior uncertainty in p. What is the probability of observing 8 water in 15 tosses?

```{r}

w <- rbinom( 1e4 , size=15 , prob=samples )

simplehist( w )

p <- table(w)/1e4

p[9]

```

### 3M4. Using the posterior distribution constructed from the new (8/15) data, now calculate the probability of observing 6 water in 9 tosses.

```{r}

w <- rbinom( 1e4 , size=9 , prob=samples )

simplehist( w )

p <- table(w)/1e4

p[7]

```

### 3M5. Start over at 3M1, but now use a prior that is zero below p = 0.5 and a constant above p = 0.5.This corresponds to prior information that a majority of the Earthâ€™s surface is water. Repeat each problem above and compare the inferences. What difference does the better prior make? If it helps, compare inferences (using both priors) to the true value p = 0.7.

```{r}

n_water <- 8
n <- 15
grid.size <- 1e4

prior <- ifelse( p_grid < 0.5 , 0 , 1 )

calc_posterior( n_water, n, prior, grid.size )

samples <- sample( p_grid, size=grid.size, prob=posterior, replace = T )

HPDI( samples, 0.9 )

# 3M3

w <- rbinom( 1e4 , size=15 , prob=samples )

simplehist( w )

p <- table(w)/1e4

p[9]

# 3M4

w <- rbinom( 1e4 , size=9 , prob=samples )

simplehist( w )

p <- table(w)/1e4

p[7]

```

### 3M6 *

```{r}

quantile( samples , c(0.99, 1) )

PI( samples, prob=0.99 )

```
### 3H1

```{r}

data(homeworkch3) 

n_boys <- 1
n_births <- 1
grid.size <- 1e4

prior <- rep(1,grid.size)

calc_posterior( n_boys, n_births, prior, grid.size )

# the value of one maximises the posterior probability of a birth being a boy

```

### 3H2

```{r}

samples <- sample( p_grid, size=1e4, replace=T, prob=posterior )

HPDI( samples, prob=0.5 )
HPDI( samples, prob=0.89 )
HPDI( samples, prob=0.97 )

```
### 3H3

```{r}

b <- rbinom( 1e4 , size=200 , prob=samples )
simplehist( b )

p <- table(b)/1e4

p

dens(b)

#does the model include 111 boys as a central likely outcome? no, the model is skewed towards 200 boys in 200 births

```



### 3H4

```{r}

sum(birth1)  

b <- rbinom( 1e4 , size=100 , prob=samples )
dens( b )

```

### 3H5 

```{r}



```

